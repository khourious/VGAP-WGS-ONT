#!/bin/bash

while getopts ":r:s:dt:" opt; do
	case $opt in
		r ) RAWPATH="$OPTARG";;
		s ) SAMPLESHEET="$OPTARG";;
		d ) PLOTDEPTH=yes;;
		t ) THREADS="$OPTARG";;
	esac
done
shift $((OPTIND -1))

if [[ -z "$RAWPATH" ]] || [[ -z "$SAMPLESHEET" ]] || [[ -z "$THREADS" ]]; then
	echo "Assembly pipeline for WGS using ONT

Usage: $(basename $0) [-r RAWPATH] [-s SAMPLESHEET] [-t THREADS]

-r  The FULL PATH to the directory containing the raw sequencing data (fast5 files).
-s  The FULL PATH to the sample sheet (.csv) file.
-d  Generates depth plots in PDF file from BAM files to briefly check coverages.
-t  Number of tasks to process concurrently."
	exit 1
fi

bg() {

    start=$(date +%s.%N)

    VGAP=$(find $HOME -type d -name "vgapWGS-ONT")

    assembly_minion.sh $SAMPLESHEET $RAWPATH $THREADS

    source activate plot

    if [[ -n "$PLOTDEPTH" ]]; then
        for i in $(find $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/ -type f -name "*.primertrimmed.rg.sorted.bam" | while read o; do basename $o | awk -F. '{print $1}'; done | sort -u); do fastcov -l $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/"$i".primertrimmed.rg.sorted.bam -o $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/"$i".coverage.pdf; done
        gs -dSAFER -r3000 -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -sOUTPUTFILE=$VGAP/LIBRARIES/$(basename $RAWPATH)/CONSENSUS/$(basename $RAWPATH).depth.pdf $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/*.pdf
    fi

    end=$(date +%s.%N)

    runtime=$(python -c "print(${end} - ${start})")

    echo "" && echo "Done. The runtime was $runtime seconds."

}

bg $1 $2 $3 &>>"$VGAP/LIBRARIES/$(basename $RAWPATH)"_log.txt &
