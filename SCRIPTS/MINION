#!/bin/bash

while getopts ":r:s:g:t:d:" OPT; do
    case $OPT in
        r ) RAWPATH="$OPTARG";;
        s ) SAMPLESHEET="$OPTARG";;
        t ) THREADS="$OPTARG";;
        g ) GPUMEM="$OPTARG";;
        d ) PLOTDEPTH=yes;;
    esac
done
shift $((OPTIND -1))

if [[ -z "$RAWPATH" ]] || [[ -z "$SAMPLESHEET" ]] || [[ -z "$THREADS" ]] || [[ -z "$GPUMEM" ]]; then
    echo "Assembly pipeline for WGS using ONT

Usage: $(basename $0) [-r RAWPATH] [-s SAMPLESHEET] [-t THREADS] [-g GPUMEM] [-d]

-r  Path containing the fast5 sequencing data.
-s  Path containing the sample sheet in .csv.
-t  Number of CPU worker threads (i.e.: i7-9750H=12).
-g  GPU memory to determine the number of runners per GPU device (i.e.: RTX 2060=6; RTX 2080=8).
-d  Generates depth plots in PDF file from BAM files to briefly check coverages."
    exit 1
fi

VGAP=$(find $HOME -type d -name "vgapWGS-ONT")

bg() {

    start=$(date +%s.%N)

    $VGAP/SCRIPTS/assembly_hac.sh $SAMPLESHEET $RAWPATH $THREADS $GPUMEM

    source activate plot

    if [[ -n "$PLOTDEPTH" ]]; then
        for i in $(find $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/ -type f -name "*.primertrimmed.rg.sorted.bam" | while read o; do basename $o | awk -F. '{print $1}'; done | sort -u); do fastcov -l $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/"$i".primertrimmed.rg.sorted.bam -o $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/"$i".coverage.pdf; done
        gs -dSAFER -r3000 -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -sOUTPUTFILE=$VGAP/LIBRARIES/$(basename $RAWPATH)/CONSENSUS/$(basename $RAWPATH).depth.pdf $VGAP/LIBRARIES/$(basename $RAWPATH)/ANALYSIS/*.pdf
    fi

    end=$(date +%s.%N)

    runtime=$(python -c "print(${end} - ${start})")

    echo "" && echo "Done. The runtime was $runtime seconds."

}

bg $1 $2 $3 $4 &>>"$VGAP/LIBRARIES/$(basename $RAWPATH)"_log.txt &
